library(ggpubr)
library(dplyr)
library(pwr)
library(Hmisc)

nombres <- c("Pediatría", "Obstetricia", "Dermatología", "Psiquiatría", "Medicina Interna", "Oncología", "Neurología", "Anestesiología", "Radiología")     
mujeres <- c(54,71,35,30,45,44,56,21,17)
hombres <- c(52,66,41,42,65,62,88,40,45)

datos <- data.frame(nombres,mujeres,hombres)

"
------------------------------------------------------------------------------------------------------------------------------
1) Estudios previos habían determinado que la proporción de autoras en la especialidad de pediatría era de 35%.
¿Respaldan estos datos tal estimación?


Para evaluar el problema se utilizará una prueba de proporciones, ya que se necesita corroborar si con
la muestra cumple con el valor nulo que se solicita.

---Evaluando condiciones:

    -Independencia: Los datos fueron escogidos de manera aleatoria y evidentemente representa a menos del 10%
                    de la poblacion de autores y autoras científicas.
                    
    -Condición éxito-fracaso: Suponiendo que se cumple el valor nulo de proporcion 
    
            0.35*373      = 130.55  >= 10
            (1 -0.35)*373 = 242.45  >= 10
            
            Como presenta mas de 10 observaciones en cada caso de éxito o fracaso, se concluye que se cumple
            con la condición de éxito-fracaso.

Entonces, se procede a realizar las hipótesis a evaluar:

---Hipótesis
-Lenguaje natural:
H0 : La proporción de autoras en la especialidad de pediatría es igual a 35%.
HA : La proporción de autoras en la especialidad de pediatría es distinta a 35%.

-Lenguaje matemático:
Sea el valor nulo p0 = 0.35
H0 : p  = p0
HA : p != p0


-------
Observaciones:

-Se determina utilizar una prueba de proporciones de Wilson (funcion prop.test()) para una muestra bilateral,
ya que puede entregar un p-valor que permita corroborar si la proporción cumple con la hipótesis nula.


-Se determinó utilizar un nivel de confianza del 90%, ya que la muestra resulta pequeña en comparación a la
posible suma de las profesionales del área de pediatría, por lo que se necesita ser mas estrictos al momento
de revisar la prueba de proporción de Wilson.
"

alpha <- 0.1                                  #nivel de confianza
n <- datos$mujeres[nombres == "Pediatría"]    #cantidad de mujeres
p <- 0.35                                     #valor nulo
x <- n / sum(mujeres)                         #proporción en la muestra

cat("------------------------------------------------\n")
cat("Prueba de proporciones para el problema 1.")
print(prop.test(x = x,n = n,p =p,alternative="two.sided",conf.level = alpha))
cat("------------------------------------------------\n")

"
Conclusión: 
Se obtuvo un p-valor < a, por lo que con un 90% de seguridad se concluye que se rechaza la hipótesis nula a 
favor de la alternativa. Por lo tanto, la proporción de las autoras en el área de pediatría es 
distinta a 35%.
------------------------------------------------------------------------------------------------------------------------------
"
"
2) Según estos datos, ¿es igual la proporción de autoras en las áreas de anestesiología y pediatría?"
"Se extiende del ejercicio anterior que las condiciones se cumplen para esta prueba,
por lo que se procede a plantear las hipotesis"
"en lenguaje humano:
  
H0: La proporción de autoras de Anesteiologia y pediatria son iguales
HA: La proporion de autoras de Anestesiologia y pediatria no son iguales

en lenguaje matematico:
  sea #beta# la probabilidad de obtener un error de tipo 2, se debe conocer el tamaño de
efect y realizar una prueba de poder de 2 proporciones para determinar este beta, que 
concluira si efectivamente podemos afirmar igualdada(si es muy pequeño) o no igualdad
(si es muy grande)"

mujeresAnestesiologia <- datos$mujeres[nombres == "Anestesiología"]/sum(mujeres)#proporcion de anestesiologas
mujeresPediatria <- datos$mujeres[nombres == "Pediatría"]/sum(mujeres)#proporcion de pediatras

tamaño_del_efecto <- ES.h(mujeresPediatria,mujeresAnestesiologia)#se calcula el tamaño de efecto para este caso
n <- 9 #cantidad de especialidades

"finalmente se calcula Beta restando a 1 el nivel de significación que resulta de la prueba de poder para 2 proporciones"
beta <- (1 - pwr.2p.test(h = tamaño_del_efecto, n = n, power = NULL, alternative = "two.sided")$power) *100
"*multiplicando por 100 para que quede expresado en porcentaje."
"Respuesta: La probabilidad de cometer un error de tipo 2 es del 90,2%, por lo que con un 95% de confianza 
se concluye que las proporciones de las autoras del aréa de anestesiología y pediatría no son iguales.
------------------------------------------------------------------------------------------------------------------------------
"
"
------------------------------------------------------------------------------------------------------------------------------
3) Suponiendo que la diferencia en la proporción de autoras en la especialidad de medicina interna 
y la de dermatología es de 0,15. ¿A cuántos autores deberíamos monitorear para obtener un intervalo 
de confianza del 97,5% y poder estadístico de 80%, si se intenta mantener aproximadamente la misma 
proporción de gente estudiada en cada caso?


Para este problema se necesita obtener el tamaño de la muestra en las áreas de dermatología y medicina
interna para ambos casos (hombres y mujeres) a modo de mantener una diferencia de 0.15 entre las proporciones
de mujeres de dermatología y medicina interna.
"
#Se obtienen los datos globales de cada especialidad
autores_D  <- datos$mujeres[nombres == "Dermatología"] +  datos$hombres[nombres == "Dermatología"]
autores_MI <-  datos$mujeres[nombres == "Medicina Interna"] +  datos$hombres[nombres == "Medicina Interna"]

#Cantidad de personas que deberían existir en cada área para obtener la diferencia de proporciones solicitada
#en el enunciado en la muestra
N_D  <- datos$mujeres[nombres == "Dermatología"] + 2
N_MI <- datos$mujeres[nombres == "Medicina Interna"] - 8

prop_mujeres_D  <- (N_D)/autores_D
prop_mujeres_MI <- (N_MI)/autores_MI

dif1 <- prop_mujeres_D - prop_mujeres_MI

#Se corrobora que la diferencia es de 0.15
cat(dif1)

#Se obtienen los valores para aplicar la prueba de Wilson para dos proporciones, ya que esta
#calcula la cantidad de personas que deben existir en cada grupo

fraccion = N_D/(N_D + N_MI)

poder_deseado <- 0.8
intervalo <- 0.025

bsamsize(p1=prop_mujeres_D,
         p2 = prop_mujeres_MI,
         fraction = fraccion,
         alpha = intervalo,
         power=poder_deseado)


"
Respuesta: Se deberían estudiar a 202 autores para mantener una diferencia de proporciones aproximada de 0.15 entre las mujeres
del área de dermatología y medicina interna.
------------------------------------------------------------------------------------------------------------------------------


"
  